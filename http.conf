map $http_origin $allow_origin {
    include _SITE_ROOT_/cors-whitelist.map;
    default '';
}
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}
server {
    listen 80;
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/mbr.massbitroute.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mbr.massbitroute.com/privkey.pem;
    # resolver 8.8.4.4 ipv6=off;
    # client_body_buffer_size 512K;
    # client_max_body_size 1G;
    server_name monitor.mbr.massbitroute.com;
    location /push {
        proxy_set_header X-Scheme $scheme;
        proxy_set_header X-Script-Name /push;
        proxy_pass http://127.0.0.1:18889;
    }
    location /mbr/check_mk/ {
        # rewrite /mbr/check_mk/(.*) /$1 break;
        # limit_except GET {
        #     deny all;
        # }
        # proxy_set_header Host $host;
        # proxy_set_header X-Real-IP $remote_addr;
        # proxy_set_header X-Forwarded-For $remote_addr;
        # proxy_set_header X-Forwarded-Host $remote_addr;
        # proxy_pass_request_headers on;
        proxy_pass http://localhost:5000;
    }
}
server {
    listen 80;
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/mbr.massbitroute.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mbr.massbitroute.com/privkey.pem;
    resolver 8.8.4.4 ipv6=off;
    client_body_buffer_size 512K;
    client_max_body_size 1G;
    server_name stat.mbr.massbitroute.com;
    # access_log /massbit/massbitroute/app/src/sites/portal/logs/nginx-access.log main_json;
    # error_log /massbit/massbitroute/app/src/sites/portal/logs/nginx-error.log debug;
    #    include /massbit/massbitroute/app/src/sites/services/gateway/cors.conf;
    # location /__internal_status_vhost/ {
    #     vhost_traffic_status_bypass_limit on;
    #     vhost_traffic_status_bypass_stats on;
    #     vhost_traffic_status_display;
    #     vhost_traffic_status_display_format html;
    # }
    # Proxy for Prometheus gateway
    location /__internal_prometheus_gw/ {
        # limit_except GET {
        #     deny all;
        # }
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Host $remote_addr;
        proxy_pass_request_headers on;
        proxy_pass http://127.0.0.1:44449/__internal_prometheus_gw/;
    }
    # Proxy for Prometheus Node
    location /__internal_prometheus_node/ {
        # limit_except GET {
        #     deny all;
        # }
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Host $remote_addr;
        proxy_pass_request_headers on;
        proxy_pass http://127.0.0.1:44448/__internal_prometheus_node/;
    }
    # Proxy Grafana Live WebSocket connections.
    location /__internal_grafana/api/live {
        include _SITE_ROOT_/cors.conf;
        # rewrite ^/(.*) /$1 break;
        rewrite ^/__internal_grafana/(.*) /$1 break;
        proxy_set_header X-WEBAUTH-USER admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Host $remote_addr;
        proxy_pass_request_headers on;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $http_host;
        proxy_pass http://127.0.0.1:44444/;
    }
    location /__internal_grafana/ {
        limit_except GET POST {
            deny all;
        }
        include _SITE_ROOT_/cors.conf;
        proxy_set_header X-WEBAUTH-USER admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Host $remote_addr;
        proxy_pass_request_headers on;
        proxy_pass http://127.0.0.1:44444/;
        proxy_http_version 1.1;
        proxy_ssl_verify off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
